---
title: "R Notebook"
output: html_notebook
---

# Setup and Opend Database Connection

```{r}
rm(list=ls())

# Load needed libraries
library(odbc)
library(igraph)
library(stringr)
library(tidyverse)

# set global variables
odbcString <- "ipeds"

# set this for reproducibility of results
set.seed(1001)

grabData <- function(dbString, queryString)
{
  # Open a connection
  connection <- dbConnect(odbc::odbc(), dbString)
  
  response <- dbSendQuery(connection, queryString)
  tbl <- dbFetch(response)
  dbClearResult(response)
  
  # disconnect from the database
  dbDisconnect(connection)

  return(as_tibble(tbl))
}

```

## Load Institutions Table

```{r}
qry <- 'SELECT i.UNITID AS Unitid,
               i.INSTNM AS InstitutionName,
               i.STABBR AS [State],
               i.CONTROL AS ControlCode,
               i.HLOFFER AS HighestLevelOffering
         FROM  dbo.HD2014 i'

insts <- grabData(odbcString, qry)

rm(qry)

insts

```

## Load Peers Table

```{r}
qry <- "SELECT c.UNITID AS Unitid, c.CGUNITID AS PeerUnitid FROM dbo.CUSTOMCGIDS2014 c"

peers <- grabData(odbcString, qry)

rm(qry)

peers

```

# What Peers Do We Follow?

```{r}
unl.peers <- peers %>%
  filter(Unitid==181464) %>%
  inner_join(insts, by=c('PeerUnitid' = 'Unitid')) %>%
  mutate(Unitid = PeerUnitid) %>%
  select(Unitid, InstitutionName, State)

unl.peers

```

# Institutions That Consider UNL a Peer

```{r}
watchers <- peers %>%
  filter(PeerUnitid==181464) %>%
  group_by(Unitid) %>%
  summarise(count=n()) %>%
  ungroup() %>%
  inner_join(insts) %>%
  select(Unitid, InstitutionName, State)

watchers
```

# Mututal Peers

```{r}
mutual <- watchers %>%
  intersect(unl.peers)

mutual
```

# Network

```{r}
base.group <- insts %>%
  filter(Unitid==181464) %>%
  select(Unitid, InstitutionName, State) %>%
  union(watchers) %>%
  union(unl.peers) %>%
  select(Unitid, InstitutionName, State)

ids <- base.group %>%
  select(Unitid)

# create odes for the graph.  This is an unduplicated list of things that are related.
net.nodes <- peers %>%
  inner_join(ids) %>%
  inner_join(insts, by=c('PeerUnitid' = 'Unitid')) %>%
  mutate(Unitid = PeerUnitid) %>%
  select(Unitid, InstitutionName, State) %>%
  union(base.group)

# create edges for graph -- this contains the id pairs for each relatiohship.
net.edges <- ids %>%
  inner_join(peers)

# create igraph object from nodes and edges
g <- graph_from_data_frame(d=net.edges, vertices=net.nodes, directed=TRUE)


l <- layout_with_kk(g)
# l <- layout_with_fr(g)

# Set edge names to institution names rather than unitid's
net.nodes <- net.nodes %>%
  mutate(vgroup = 5,
         vgroup = ifelse(Unitid %in% watchers$Unitid, 4, vgroup),
         vgroup = ifelse(Unitid %in% unl.peers$Unitid, 3, vgroup),
         vgroup = ifelse(Unitid %in% mutual$Unitid, 2, vgroup),
         vgroup = ifelse(Unitid == 181464, 1, vgroup))

```


```{r}
# display the labels only for desired institutions
V(g)$label <- net.nodes$InstitutionName
V(g)$label[!net.nodes$vgroup > 2] <- ''

# set the vertex group to user-defined groups
V(g)$group <- net.nodes$vgroup

# set edge color based on group
E(g)$color <- '#e6e6e6'
E(g)[net.edges$Unitid==181464]$color <- '#cc0000'

#plot the network
plot(g, edge.arrow.size=.2,
     vertex.size=5,
     vertex.label.cex=.5,
     vertex.color=c("#cc0000","#ff6666","#ffcccc","#737373","#e6e6e6")[V(g)$group],
     vertex.frame.color=c("#cc0000","#ff6666","#ffcccc","#737373","#e6e6e6")[V(g)$group],
     layout=l)


```

